---
title: "Econ_hw_3"
author: "Sarah Rohlfing, Alessandra Puig-Santana"
date: "5/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(here)

```

## Read in the data
```{r}
hw3_data <- read.csv(here("data", "HW3_data.csv")) %>% 
  clean_names() 
```

## Tidy data w/ pivot
```{r}
elec_longer <- pivot_longer(data =hw3_data,
                            cols = q_low_kwh:q_high_kwh,
                            names_to = "income_group",
                            values_to = "quantity_kwh")
```

## Graph Price v. Income Group per kilowatt hour
```{r}

ggplot(data = elec_longer, aes(y = price_cents, x = quantity_kwh)) +
  geom_point() +
  geom_smooth(method =lm, se = FALSE) +
  facet_wrap( ~income_group)+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demand for low and high income households")

```

```{r}
#hw3_data %>% 
#hw3_data$q_agg_sum = q_low_kwh + q_high_kwh ## did this not work?

hw3_data$price_dollars <- hw3_data$price_cents/100
```

### Linear model for low income group
```{r}
low.income.lm <-lm(price_cents ~ q_low_kwh, data = hw3_data)
slope.low <- low.income.lm$coefficient[2]
intercept.low <- low.income.lm$coefficient[1]
vector_range <- seq(0, 160000, length.out = 19)
hw3_data$low_demand = slope.low*(vector_range) + intercept.low

ggplot(data = hw3_data, aes(y = price_cents, x = low_demand)) +
  geom_line() +
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demand for low income")

```

### Linear model for high income group
```{r}
high.income.lm <-lm(price_cents ~ q_high_kwh, data = hw3_data)
slope.high <- high.income.lm$coefficient[2]
intercept.high <- high.income.lm$coefficient[1]
hw3_data$high_demand = slope.high*(vector_range) + intercept.high

ggplot(data = hw3_data, aes(y = price_cents, x = high_demand)) +
  geom_line()+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demand for high income")
```

```{r}
## slope for the demand line
demand <- function(p, model){
  q <- (p - model$coefficients[1])/model$coefficients[2]
  q <- ifelse(q<0, 0, q)
  return(q)
}


```

```{r}
demand_ex <- demand(p= 10, model = low.income.lm) #(example: to find what demand function will output at price = 2)
```

### Demand aggregate curve 
```{r}
demand_agg <- function(p){
  q <- demand(p, low.income.lm) + demand(p, high.income.lm)
  return(q)
}
price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()
df<- tibble(Qagg = Qagg, price = price)

ggplot(data = df, aes(y = price, x = Qagg)) +
  geom_line()+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Aggregate Demand")
```


```{r}
q_star_agg <- demand_agg(p=10) # q_star_agg = 536,719 kwH
p_star_before_tax <- 10 #10 cents is p star
```

```{r}
# find slope for supply curve
mpc_slope = p_star_before_tax/q_star_agg # slope of supply curve = 1.86e-5

df$q_random <- seq(0, 80000, length.out = 100)

hw3_data$q_kwh_sum <- hw3_data$q_low_kwh + hw3_data$q_high_kwh


df$supply_lm <- mpc_slope * df$q_random


#df$mpc_prices = mpc_slope*(Qagg) 

ggplot(data = df, aes(y = price, x = supply_lm)) +
  geom_point()

```

Question 1: One kWh of electricity emits 0.85 pounds of CO2. Assuming that the interim SCC correctly reflects the total social cost of one metric ton of CO2, what is the marginal externality cost per kwH of electricity?

```{r}
# $51/1 metric ton * 0.000453592 metric tons/1 lb = $.0231/lb *.85 lb/kwh = $0.01966/kwh
# $ 0.10 + $0.01966 = $0.12/kwh (marginal external cost/kwh)

tax <- function(scc){
  t <- scc * .000453592 * 0.85 * 100
  return(t)
}

tax(scc = 51)

mec_per_kwh <- 12 # <- marginal external cost in dollars
```

The marginal externality cost per kwH of electricity is $`r round(tax(scc = 51), 4)`. 

Question 2: What is the aggregate monthly demand curve for electricity? What is the supply curve for electricity? What is the “benefit” to consumers under the status quo? What is the “benefit” to producers under the status quo? What is the environmental cost under the status quo?

```{r}
CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[1] - p)*q
  return(cs)}

# CS_ex <- CS(p = 10, model = low.income.lm) to test low income consumer surplus

CS_agg <- function(p){
  cs <- CS(p,low.income.lm) + CS(p,high.income.lm)
  return(cs)}

agg_consumer_surplus <- CS_agg(p=10) # = 5298722 cents
# convert to dollars
agg_cs_dollars <- agg_consumer_surplus/100 # = $52,987
```

```{r}
Supply_fun <- function(q){
  p <- q*mpc_slope
  return(p)
}

Supply_fun(q=500000) # about 10 cents, yay

PS <- function(p){
  ps <- 0.5 * p * q_star_agg #might be wrong! had: .5 * p/mpc_slope
  return(ps)}

PS_status_quo <- PS(p = 10) # = 2,683,597 cents producer surplus under status quo
#convert to dollars
PS_sq_dollars <- PS_status_quo/100 # = $26,836
```

```{r}
# find environmental damage costs under status quo

env_cost <- tax(51) # $0.01966 per kwh of env. damage
env_cost_sq <- (tax(51) * q_star_agg)/100 # = $10,734.39 of env damage under status quo q_star of 536719 kwh
```

```{r}
# find consumer surplus for low income vs. high income
low_cs_sq <- CS(p = 10, model = low.income.lm) # 811243 cents with the status quo, convert to dollars
low_cs_sq_dollars <- low_cs_sq/100 # = $8,112

high_cs_sq <- CS(p = 10, model = high.income.lm) # 4487479 cents with status quo, convert to dollars
high_cs_sq_dollars <- high_cs_sq/100 # = $44,875

# High income has a much higher consumer surplus than low income. High income has a surplus of $36,763 higher than low income.
```

Question 3: How is the current consumer benefit divided between “high” and “low” income consumers? 

High income has a much higher consumer surplus than low income. High income has a surplus of $36,763 higher than low income.

Question 4: Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent research has shown the poor face a disproportionate share of the impacts from climate change, assume that the climate externality is borne entirely by the “low” income group. What would be the effects of this tax on:
(a) The amount of electricity produced and consumed
(b) The price of electricity
(c) Overall welfare of “high” income consumers
(d) Overall welfare of “low” income consumers
(e) Power suppliers (i.e., electricity producers)
(f) Total environmental damage
(g) Total tax revenue generated

```{r}
# P = mQ + b 
# P = b - t + mQ
# low income bears all the burden

new_low_intercept <- function(scc)
  {low_int <- low.income.lm$coefficients[1]- tax(scc)
  return(low_int)}
new_low_intercept(scc = 51) #= 21.404 is new y-intercept for the low income demand curve

low_demand_tax <- function(p, scc){
  q <- (p - new_low_intercept(scc))/low.income.lm$coefficients[2]
  return(q)
}

# low_demand_tax(p = 10, scc = 51)

Q_demand_agg_tax <- function(p, scc){
  q <- low_demand_tax(p, scc) + demand(p, high.income.lm)
  return(q)
}
tax_51_q <- Q_demand_agg_tax( p = 10, scc = 51) # = 518875 kwh is the q star with scc = to 51

# reduction in kwh consumption from 536719 - 518875

536719-518875 # = 17844 kwh reduction with the new tax.
```


Find high income consumer surplus with the tax
```{r}
CS_tax_high <- CS(p = 12, model = high.income.lm) # = 3695177 cents
# convert to dollars
CS_tax_high_dollars <- CS_tax_high/100 # = $36952
# Originally was $44875
44875-36952 # = $7923 less in consumer surplus with the SCC = 51
```


```{r}
CS_low_income <- function(p, scc, model){
  q <- low_demand_tax(p, scc)
  cs <- 0.5*(new_low_intercept(scc) - p)*q
  return(cs)}

CS_tax_low <- CS_low_income(p = 10, scc = 51, model = low.income.lm) # = 590186
CS_tax_low_dollars <- CS_tax_low/100 #= $5902 in the new CS
#The difference in consumer surplus 
low_cs_sq_dollars - CS_tax_low_dollars # = $2210.57 less in consumer surplus

```


Find the Producer surplus with the added tax. need to go down from 10 by 2(the environmental cost). This way the entire tax revenue will be 4 * the new q star
```{r}
PS_tax <- (0.5* tax_51_q * (10 - tax(51)))/100 # turning it into dollars

PS_difference <- PS_sq_dollars - PS_tax # = a difference of $6,081
```

Total environmental damage
```{r}
env_damage_w_tax <- (Q_demand_agg_tax(p = 10, scc = 51) * 2)/100 # = $10,377

env_difference <- env_cost_sq - env_damage_w_tax # = $176 of env damage saved with the new tax
```

Total tax rev generated
```{r}
tax_rev_51 <- (Q_demand_agg_tax(p = 10, scc = 51) * env_cost*2)/100 # = $20,405 of tax revenue (is this too high??? Sandy made it sound like it had to be 4 cents for the height of the tax revenue)
```

Question 5: Now, assume that all revenue from the electricity tax will be redistributed to the consumers in proportion to their pre-tax consumption. For example, if 80% of the electricity was consumed by “high” income consumers, then they get 80% of the tax revenue. Additionally, consider the fact that current scientific evidence suggests the true SCC may be much higher than $51. For a range of SCC values ($51, $75, $100, $125, and $150 per metric ton of CO2), calculate the effects of an SCC-based electricity tax on:
(a) Overall welfare of “high” income consumers
(b) Overall welfare of “low” income consumers
(c) Electricity producers
```{r}
# high = CS(function of tax and MEC) + pre tax rebate
# high tax rebate = q_high/(q_high + q_low) * tax rev(changes with scc)
# low = CS + pre tax rebate - [MEC * q_tax_51]
# low tax rebate = q_low/(q_high+q_low) * tax revenue

high_income_proportion <- demand(model = high.income.lm, p = 10)/(demand(model = high.income.lm, p = 10) + demand(model = low.income.lm, p = 10)) # all this is under status quo = .774

low_income_proportion <- demand(model = low.income.lm, p = 10)/(demand(model = high.income.lm, p = 10) + demand(model = low.income.lm, p = 10)) # = .226
```


```{r}
high_welfare <- (CS_tax_high + high_income_proportion * Q_demand_agg_tax(p = 10, scc = 150))/100 # = $40,967
```
consumer surplus for high income at:
$51: $40,967
$75: $40,902
$100:  $40,835
$125: $40,767
$150: $40,699

```{r}
low_welfare <- (CS_tax_low + low_income_proportion * Q_demand_agg_tax(p = 10, scc = 150))/100 # = 7,075
```
consumer surplus for low income at scc:
$51: $7,075
$75: $7,056
$100: $7,036
$125: $ 7,016
$150: $ 6,997

```{r}
#Q_demand_agg_tax <- function(p, scc){
  #q <- low_demand_tax(p, scc) + demand(p, high.income.lm)
 # return(q)}

PS_fun_w_tax <- function(p, scc){
  ps <- ((10 - tax(scc))* Q_demand_agg_tax(p, scc)) * 0.5
  return(ps)
}

PS_51 <- PS_fun_w_tax(p = 10, scc = 51)/100 # = $23,019 this isn't right....i feel like it should be the same as the previous PS_tax
 
PS_fun_w_tax(p = 10, scc = 150)/100
```
producer surplus at scc:
$51: $23,019
$75: $18,143
$100: $15,414
$125: $12,770
$150: $10,209


6. Suppose the “high” income group has access to expensive home solar generation. This lowers
the electricity demand curve for the “high” income group by half (vertically). Under this new
demand:
(a) What is total electricity consumption?
(b) What is the total environmental externality?
(c) What value of the electricity tax makes the total environmental damage the same as the
damage when solar panels are available to the high income group?