---
title: "Econ_hw_3"
author: "Sarah Rohlfing"
date: "5/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(here)

```


```{r}
hw3_data <- read.csv(here("data", "HW3_data.csv")) %>% 
  clean_names() 
  
```

```{r}
elec_longer <- pivot_longer(data =hw3_data,
                            cols = q_low_kwh:q_high_kwh,
                            names_to = "income_group",
                            values_to = "quantity_kwh")
```

```{r}

ggplot(data = elec_longer, aes(y = price_cents, x = quantity_kwh)) +
  geom_point() +
  geom_smooth(method =lm, se = FALSE) +
  facet_wrap( ~income_group)+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demend for low and high income households")

```
```{r}
#hw3_data %>% 
#hw3_data$q_agg_sum = q_low_kwh + q_high_kwh

hw3_data$price_dollars <- hw3_data$price_cents/100
```


```{r}
low.income.lm <-lm(price_cents ~ q_low_kwh, data = hw3_data)
slope.low <- low.income.lm$coefficient[2]
intercept.low <- low.income.lm$coefficient[1]
vector_range <- seq(0, 160000, length.out = 19)
hw3_data$low_demand = slope.low*(vector_range) + intercept.low

ggplot(data = hw3_data, aes(y = price_cents, x = low_demand)) +
  geom_line() +
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demand for low income")

```
```{r}
high.income.lm <-lm(price_cents ~ q_high_kwh, data = hw3_data)
slope.high <- high.income.lm$coefficient[2]
intercept.high <- high.income.lm$coefficient[1]
hw3_data$high_demand = slope.high*(vector_range) + intercept.high

ggplot(data = hw3_data, aes(y = price_cents, x = high_demand)) +
  geom_line()+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Demand for high income")
```

```{r}
demand <- function(p, model){
  q <- (p - model$coefficients[1])/model$coefficients[2]
  q <- ifelse(q<0, 0, q)
  return(q)
}


```

```{r}
demand_ex <- demand(p= 10, model = low.income.lm) #(example: to find what demand function will output at price = 2)
```


```{r}
demand_agg <- function(p){
  q <- demand(p, low.income.lm) + demand(p, high.income.lm)
  return(q)
}
price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()
df<- tibble(Qagg = Qagg, price = price)

ggplot(data = df, aes(y = price, x = Qagg)) +
  geom_line()+
  labs(x = "kwH",
       y = "Price of kwH",
       title = "Aggregate Demand")
```


```{r}
q_star_agg <- demand_agg(p=10) # q_star_agg = 536,719 kwH
p_star_before_tax <- 10 #10 cents is p star
```

```{r}
# find slope for supply curve
mpc_slope = p_star_before_tax/q_star_agg # slope of supply curve = 1.86e-5

df$q_random <- seq(0, 80000, length.out = 100)

hw3_data$q_kwh_sum <- hw3_data$q_low_kwh + hw3_data$q_high_kwh


df$supply_lm <- mpc_slope * df$q_random


#df$mpc_prices = mpc_slope*(Qagg) 

ggplot(data = df, aes(y = price, x = supply_lm)) +
  geom_point()

```

```{r}
# $51/1 metric ton * 0.000453592 metric tons/1 lb = $.0231/lb *.85 lb/kwh = $0.01966/kwh
# $ 0.10 + $0.01966 = $0.12/kwh (marginal external cost/kwh)

tax <- function(scc){
  t <- scc * .000453592 * 0.85 * 100
  return(t)
}

tax(scc = 51)

mec_per_kwh <- 12 # <- marginal external cost in dollars
```



```{r}
CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[1] - p)*q
  return(cs)}

# CS_ex <- CS(p = 10, model = low.income.lm) to test low income consumer surplus

CS_agg <- function(p){
  cs <- CS(p,low.income.lm) + CS(p,high.income.lm)
  return(cs)}

agg_consumer_surplus <- CS_agg(p=10) # = 5298722
# convert to dollars
agg_cs_dollars <- agg_consumer_surplus/100 # = $52,987
```

```{r}
Supply_fun <- function(q){
  p <- q*mpc_slope
  return(p)
}

Supply_fun(q=500000) # about 10 cents, yay

PS <- function(p){
  ps <- 0.5*p*q_star_agg #might be wrong! had: .5 * p/mpc_slope
  return(ps)}

PS_status_quo <- PS(p = 10) # = 2,683,597 cents producer surplus under status quo
#convert to dollars
PS_sq_dollars <- PS_status_quo/100 # = $26,836
```

```{r}
# find environmental damage costs under status quo

env_cost <- 2 # $0.01966 per kwh of env. damage
total_env_cost_sq <- env_cost * q_star_agg # = $1073439 of env damage under status quo q_star of 816,884 kwh
env_dollars_total <- total_env_cost_sq/100 # = $10,734
```

```{r}
# find consumer surplus for low income vs. high income
low_cs_sq <- CS(p = 10, model = low.income.lm) # 811243 with the status quo, convert to dollars
low_cs_sq_dollars <- low_cs_sq/100 # = $8,112

high_cs_sq <- CS(p = 10, model = high.income.lm) # 4487479 cents with status quo, convert to dollars
high_cs_sq_dollars <- high_cs_sq/100 # = $44,875

# High income has a much higher consumer surplus than low income. High income has a surplus of $36,763 higher than low income.
```

```{r}
# P = mQ + b 
# P = b - t + mQ
new_demand_w_tax <- function(p, scc){
  q <- demand(p, low.income.lm) + demand(p, high.income.lm) - tax(scc)
  return(q)}

ex1 <- new_demand_w_tax(p = 10, scc = 51)

 #q <- demand(p, low.income.lm) + demand(p, high.income.lm)

#demand_agg <- function(p){
  #q <- demand(p, low.income.lm) + demand(p, high.income.lm)
  #return(q)}

# demand <- function(p, model){
  #q <- (p - model$coefficients[1])/model$coefficients[2]
  #q <- ifelse(q<0, 0, q)
  #return(q)}
demand_flip <- function(q, model){
  p <- model$coefficients[1] + model$coefficients[2]*q
  return(p)
}

demand_agg_flip <- function(q){
  p <- demand_flip(q, low.income.lm) + demand(q, high.income.lm)
  return(p)
}
demand_agg_flip(q = 536718) #nope

```

